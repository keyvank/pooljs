<!DOCTYPE html>

{% load staticfiles %}

<html>
	<head>
		<title>Raisin RayTracing</title>
		<meta charset="utf-8"/>
		<script src="{% static 'js/commander.js' %}"></script>

	</head>
	<body>
		<canvas id="frame" width="640" height="480" style="border:1px solid #000000;">
		</canvas>
		<button onclick="go();">Run</button>
	</body>
	<script>
		var ctx = document.getElementById("frame").getContext("2d");
			function drawRegion(x,y,data){
				var h=data.length;
				var w=data[0].length;
				var imgdata = ctx.getImageData(x,y, w, h);
				for(var i=0;i<h;i++){
					for(var j=0;j<w;j++){
						var ind = i*w +j;
						imgdata.data[ind*4]=data[i][j][0];
						imgdata.data[ind*4+1]=data[i][j][1];
						imgdata.data[ind*4+2]=data[i][j][2];
						imgdata.data[ind*4+3]=255;
					}
				}
				ctx.putImageData(imgdata,x,y);
			}
			commander.onresult = function(result,error){
				if(!error)
					drawRegion(result[0],result[1],result[2]);
				else
					alert("There was an error with a job!");
			}

			var partsWidth = 40, partsHeight = 40;
			var width = 640, height = 480;
			function go(){
				commander.setBufferSize(100);
				commander.for(0,partsWidth*partsHeight,function(ind,width,height,partsWidth,partsHeight){
					function dot(a,b){return a[0]*b[0] + a[1]*b[1] + a[2]*b[2];}
					function cross(a,b){return [a[1]*b[2] - a[2]*b[1],a[2]*b[0] - a[0]*b[2],a[0]*b[1] - a[1]*b[0]];}
					function sum(a,b){return [a[0]+b[0],a[1]+b[1],a[2]+b[2]];}
					function neg(a){return [-a[0],-a[1],-a[2]];}
					function sub(a,b){return [a[0]-b[0],a[1]-b[1],a[2]-b[2]];}
					function mul(a,b){return [a[0]*b,a[1]*b,a[2]*b];}
					function normalize(a){var len = Math.sqrt(dot(a,a));return [a[0]/len,a[1]/len,a[2]/len];}
					function lookAt(pos,targ,up=[0,1,0],fov=Math.PI/4,aspRatio=width/height){
						var dir = normalize(sub(targ,pos));
						targ = sum(pos,dir);
						var w = Math.tan(fov);
						var h = w/aspRatio;
						var rightVec=normalize(cross(dir,up));
						var downVec=normalize(cross(dir,rightVec));
						var lt = sub(targ,sum(mul(rightVec,w/2),mul(downVec,h/2)));
						return [pos,lt,mul(rightVec,w),mul(downVec,h)];
					}
					var cam = lookAt([0,0,-100],[0,0,-99]);

					// Plane => [Normal,Position]
					// Ray => [Pos,Dir]
					function planeIntersection(plane,ray){
						var d = -dot(plane[0],ray[1]);

						if(d>0){
							var t = (plane[1] +dot(plane[0],ray[0]))/d;
							if(t>=0){
								var pos = sum(ray[0],mul(ray[1],t));
								if((Math.floor(pos[2]/100)+Math.floor(pos[0]/100))%2==0)
									return [255,255,255];
								else
									return [20,20,20];
							}
							else
								return [0,0,0];
						}
						else
							return [0,0,0];
					}

					function traceRay(ray){
						return planeIntersection([[0,1,0],100],ray);
					}
					function pixelAt(x,y){
						var hor=mul(cam[2],x/width);
						var ver=mul(cam[3],y/height);
						var targ=sum(cam[1],sum(hor,ver));
						var dir = normalize(sub(targ,cam[0]));
						return traceRay([cam[0],dir]);
					}
					var x = ind%partsWidth,y = Math.floor(ind/partsWidth);
					var data = [];
					var widthSize = width/partsWidth;
					var heightSize = height/partsHeight;
					for(var i=0;i<heightSize;i++){
						var row=[];
						for(var j=0;j<widthSize;j++){
							row.push(pixelAt(x*widthSize+j,y*heightSize+i));
						}
						data.push(row);
					}
					return [widthSize*x,heightSize*y,data];
				},[width,height,partsWidth,partsHeight]);
			}
	</script>
</html>
